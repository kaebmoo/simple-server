<div class="card pb-4">
  <h3>Cohort report</h3>
  <div class="desc">Outcomes for patients registered 3-6 months previously:
    <div class="key desktop">
      <div class="key-definition didntattend">Didn't attend for<br class="mobile"> follow-up visit</div>
      &nbsp;
      <div class="key-definition uncontrolled">Visited and <br class="mobile">BP &ge;&nbsp;140/90</div>
      &nbsp;
      <div class="key-definition controlled">Visited and <br class="mobile">BP &lt;&nbsp;140/90</div>
    </div>
  </div>

  <% cohort_analytics.each_with_index do |(report_dates, analytics), index| %>
    <%
      cohort_start, report_start = report_dates

      # Skip the current month if monthly (it's too soon to measure)
      next if @period == :month && index == 0

      registered = analytics[:registered]
      followed_up = analytics[:followed_up]
      defaulted = analytics[:defaulted]
      controlled = analytics[:controlled]
      uncontrolled = analytics[:uncontrolled]

      if @period == :quarter
        report_period = quarter_string(report_start)
        cohort_period = quarter_string(cohort_start)
      else
        report_period = report_start.strftime("%b %Y")
        cohort_period = cohort_start.strftime("%b %Y")
      end

      is_current_period = (index == 0)
    %>

    <div class="split-row">
      <div class="row px-lg-0">
        <div class="col-lg-3 nowrap order-lg-3">
          <div class="bar-total float-right float-lg-none mb-n4">Outcomes for <%= registered %> patients reg. <%= "#{cohort_period}" %></div>
        </div>
        <div class="col-lg-1 nowrap order-lg-1 pt-lg-2">
          <h6 data-toggle="tooltip" data-placement="top" data-trigger="hover focus click" title=""><%= is_current_period ? "This #{@period}" : "#{report_period}" %></h6>
        </div>
        <div class="col-lg-8 order-lg-2 pr-lg-0">
          <table class="split-bars">
            <tr>
              <% if registered > 0 %>
                <%
                  controlled_percent = (controlled.to_f / registered * 100).round
                  uncontrolled_percent = (uncontrolled.to_f / registered * 100).round
                  default_percent = (defaulted.to_f / registered * 100).round
                %>

                <td class="bar bar-1" data-toggle="tooltip" data-placement="top" data-trigger="hover focus click" title="<%= (defaulted > 0 && default_percent == 0) ? "< 1" : default_percent %>% didn't attend" style="width: <%= default_percent %>%;"><%= defaulted %></td>
                <td class="bar bar-2" data-toggle="tooltip" data-placement="top" data-trigger="hover focus click" title="<%= (uncontrolled > 0 && uncontrolled_percent == 0) ? "< 1" : uncontrolled_percent %>% visited and uncontrolled" style="width: <%= uncontrolled_percent %>%;"><%= uncontrolled %></td>
                <td class="bar bar-3" data-toggle="tooltip" data-placement="top" data-trigger="hover focus click" title="<%= (controlled > 0 && controlled_percent == 0) ? "< 1" : controlled_percent %>% visited and controlled" style="width: <%= controlled_percent %>%;"><%= controlled %></td>
              <% else %>
                <td class="bar bar-1 bar-none" style="width: 100%;">No patients</td>
              <% end %>
            </tr>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <div class="key mobile">
    <div class="row">
      <div class="col-4 key-definition didntattend">Didn't attend for follow-up visit</div>
      <div class="col-4 key-definition uncontrolled">Visited and BP &ge;&nbsp;140/90</div>
      <div class="col-4 key-definition controlled">Visited and BP &lt;&nbsp;140/90</div>
    </div>
  </div>
</div>



<div class="card pb-4">
    <h3>99 patients expected to visit this quarter</h3>
    
    <nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Overdue <strong>90</strong></a>
        <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Scheduled  <strong>9</strong></a>
        <a class="nav-item nav-link" id="nav-contact-tab" data-toggle="tab" href="#nav-contact" role="tab" aria-controls="nav-contact" aria-selected="false">Visited <strong>6</strong></a>
      </div>
    </nav>
    <div class="tab-content mt-4 mb-5" id="nav-tabContent">
      <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
              <div class="row">
                <div class="col-6">
                    <div>John Smith, M 44</div>
                    <div>55 Model Colony Road, Bathinda, Punjab</div>
                    <div><a href="#" class="btn btn-sm btn-outline-primary btn-phone">999 999 9999</a></div>
                </div>
                <div class="col-3">
                    <span class="badge badge-pill badge-danger ml-2">HIGH RISK</span>
                </div>
                <div class="col-3">
                    <a href="#" class="btn btn-sm btn-outline-primary">Mark result of contact...</a>
                </div>
              </div>
              <div class="row">
                <div class="col-6">
                    <div>John Smith, M 44</div>
                    <div>55 Model Colony Road, Bathinda, Punjab</div>
                    <div><a href="#" class="btn btn-sm btn-outline-primary btn-phone">999 999 9999</a></div>
                </div>
                <div class="col-3">
                    <span class="badge badge-pill badge-danger ml-2">HIGH RISK</span>
                </div>
                <div class="col-3">
                    <a href="#" class="btn btn-sm btn-outline-primary">Mark result of contact...</a>
                </div>
              </div>
              <div class="row">
                <div class="col-6">
                    <div>John Smith, M 44</div>
                    <div>55 Model Colony Road, Bathinda, Punjab</div>
                    <div><a href="#" class="btn btn-sm btn-outline-primary btn-phone">999 999 9999</a></div>
                </div>
                <div class="col-3">
                    <span class="badge badge-pill badge-danger ml-2">HIGH RISK</span>
                </div>
                <div class="col-3">
                    <a href="#" class="btn btn-sm btn-outline-primary">Mark result of contact...</a>
                </div>
              </div>
      </div>
      <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">...</div>
      <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">...</div>
    </div>
    

</div>