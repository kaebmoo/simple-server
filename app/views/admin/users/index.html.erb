<div class="page-header">
  <h1 class="page-title">Users</h1>
  <div class="button">
    <a href=<%= new_admin_invitation_path %>>Invite User</a>
  </div>
</div>

<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
  <% User.roles.values.each_with_index do |user_role, i| %>
    <li class="nav-item">
      <a class="nav-link <%= 'active' if i == 0 %>" id="<%= user_role %>-tab" data-toggle="tab"
         href="#<%= user_role %>" role="tab"
         aria-controls="<%= user_role %>" aria-selected=
        <% i == 0 %>>
        <%= user_role.humanize.pluralize %>
      </a>
    </li>
  <% end %>
</ul>

<!-- Tab panes -->
<div class="tab-content">
  <% User.roles.values.each_with_index do |user_role, i| %>
    <div class="tab-pane <%= 'active' if i == 0 %>" id="<%= user_role %>" role="tabpanel" aria-labelledby="<%= user_role %>-tab">
      <% @user.where(role: user_role).group_by { |user| user.registration_facility.try(:district) }.each do |district, users| %>
        <% users.each do |user| %>
          <% if district.present? %>
            <h2><%= district %></h2>
          <% end %>
          <div class="card">
            <div class="card-body">
              <div class="card-header row">
                <div class="col-sm-12 col-md-6">
                  <%= user.full_name %>
                </div>
                <div class="col-sm-12 col-md-6">
                  <div class="sync_approval_status float-right">
                    <%= user.sync_approval_status_reason %>
                    <span class="label <%= user.sync_approval_status %>"><%= user.sync_approval_status&.capitalize %></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body row">
              <div class="col-sm-12 col-md-6">
                <% if user.sync_approval_status == "allowed" && user.registration_facility.facility_group.present? %>
                  The user can sync data for
                  <%= user.registration_facility.facility_group.facilities.count %> facilities,
                  belonging to <%= user.registration_facility.facility_group.name %>.
                <% else %>
                  The user can not sync data for any facilities.
                <% end %>
                <% if user.user_permissions.present? %>
                  <h5>The user has the following permissions:</h5>

                  <ul>
                    <% user.user_permissions.group_by(&:permission_slug).each do |permission_slug, permissions| %>
                      <li><%= permission_slug %></li>
                    <% end %>
                  </ul>
                <% end %>
              </div>
              <div class="col-sm-12 col-md-6">
                <div class="float-right">
                  <% if policy(user).edit? %>
                    <%= link_to 'Edit', edit_admin_user_path(user) %>
                  <% end %>
                  <% unless user.sync_approval_status == 'denied' %>
                    <span class="light divider">|</span> <%= link_to 'Deny access', '#deny-access-modal-' + user.id, 'data-toggle' => 'modal' %>
                  <% end %>
                  <% unless user.sync_approval_status == 'allowed' %>
                    <span class="light divider">|</span> <%= link_to 'Allow access', admin_user_enable_access_path(user), method: :put, data: { confirm: I18n.t('admin.enable_access_alert') } %>
                  <% end %>
                  <%= render partial: "deny_access_modal", locals: { user: user } %>
                </div>
                <div>
                  <h3>User Authentications:</h3>
                  <% user.user_authentications.each do |user_authentication| %>
                    <h4><%= user_authentication.authenticatable_type.humanize %></h4>
                    <% if user_authentication.authenticatable_type == 'PhoneNumberAuthentication' %>
                      <p>Phone Number: <a href="tel:<%= user.phone_number %>"><%= user.phone_number %></a></p>
                    <% elsif user_authentication.authenticatable_type == 'EmailAuthentication' %>
                      <p>Email: <a href="tel:<%= user.email %>"><%= user.email %></a></p>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<!--<div class="tab-pane <%#= 'active' if i == 0 %>" id="<%#= user_role %>" role="tabpanel" aria-labelledby="<%#= user_role %>-tab">-->
<!--  <div class="table-responsive">-->
<!--    <table class="table">-->
<!--      <thead class="thead-light">-->
<!--      <tr>-->
<!--        <th>Name</th>-->
<!--        <th>Sync status</th>-->
<!--        <th>Status reason</th>-->
<!--        <th>Phone number</th>-->
<!--        <th>Registered at facility</th>-->
<!--        <th></th>-->
<!--      </tr>-->
<!--      </thead>-->

<!--      <tbody>-->
<%# @user.where(role: user_role).each do |user| %>
<!--        <tr>-->
<!--          <td class="nowrap"><%#= link_to user.full_name, [:admin, user] %></td>-->
<!--          <td class="sync_approval_status nowrap">-->
<!--            <span class="label <%#= user.sync_approval_status %>"><%#= user.sync_approval_status&.capitalize %></span>-->
<!--          </td>-->
<!--          <td class="sync_approval_status_reason"><%#= user.sync_approval_status_reason %></td>-->
<!--          <td class="nowrap"><a href="tel:<%#= user.phone_number %>"><%#= user.phone_number %></a></td>-->
<!--          <td>-->
<%# if user.registration_facility.present? %>
<%# facility = user.registration_facility %>

<%# if policy(facility).show? %>
<%#= link_to facility.name, admin_facilities_path(facility) %>
<%# else %>
<%#= user.registration_facility.name %>
<%# end %>
<%# end %>
<!--          </td>-->
<!--          <td class="nowrap">-->
<%# if policy(user).edit? %>
<%#= link_to 'Edit', edit_admin_user_path(user) %>
<%# end %>
<%# unless user.sync_approval_status == 'denied' %>
<!--              <span class="light divider">|</span> <%#= link_to 'Deny access', '#deny-access-modal-' + user.id, 'data-toggle' => 'modal' %>-->
<%# end %>
<%# unless user.sync_approval_status == 'allowed' %>
<!--              <span class="light divider">|</span> <%#= link_to 'Allow access', admin_user_enable_access_path(user), method: :put, data: { confirm: I18n.t('admin.enable_access_alert') } %>-->
<%# end %>

<%#= render partial: "deny_access_modal", locals: { user: user } %>
<!--          </td>-->
<!--        </tr>-->
<%# end %>
<!--      </tbody>-->
<!--    </table>-->
<!--  </div>-->
<!--</div>-->